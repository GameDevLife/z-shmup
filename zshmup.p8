pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
function _init()
	cls(0)
	state="start"
	--blinking text ratio
	blink=1
end

-->8
function _draw()
	if state == "start" then
			draw_start()
	elseif state == "game" then
		draw_game()
	elseif state == "end" then
		draw_game_over()
	end
end

-->8
function _update()
	--increment the blinking var
	blink+=1
	
	if state == "start" then
		update_start()		
	elseif state == "game" then
		update_game()
	elseif state == "end" then
		update_game_over()
	end
end

-->8
--controls
function p_controls()
	ship_spr=2
	--left
	if btn(0) then
		ship_spr=1
		ship_pos_x=ship_pos_x-1
	end
	--right
	if btn(1) then
		ship_spr=3
		ship_pos_x=ship_pos_x+1
	end
	--up
	if btn(2) then
		ship_pos_y=ship_pos_y-1
	end
	--down
	if btn(3) then
		ship_pos_y=ship_pos_y+1
	end
	--fire
	if btnp(4) then
		bullet_pos_y=ship_pos_y-4
		bullet_pos_x=ship_pos_x
		sfx(0)
		muzzle=5
	end
	
	if btnp(5) then
		-- todo: remove this
		-- for develop
		-- go to game over screen
		state="end"
	end
end
-->8
-- draw functions

function engine_anim()
	engine_f_spr=engine_f_spr+1
	if engine_f_spr > 8 then
		engine_f_spr=4
	end
end

function bullet_anim()
	bullet_spr=bullet_spr+1
	if bullet_spr>11 then
		bullet_spr=9
	end
end

function bullet_move()
	bullet_pos_y=bullet_pos_y-3
end

function muzzle_anim()
	if muzzle>0 then
		muzzle=muzzle-1
	end
end

function draw_score()
	print("score:"..score, 4, 4, 7)
end

function draw_lives()
	for i=1,3 do
		if lives>=i then
			spr(19,i*9+90,3)
		else
			spr(20,i*9+90,3)
		end
	end
end

function draw_starfield()
	for i=1,#starx do
			local star_color=6
			if star_speed[i]<1 then
				star_color=1
			elseif star_speed[i]<1.5 then
				star_color=13
			end
			pset(starx[i],stary[i],star_color)
	end
end

function starfield_anim()
	for i=1,#stary do
		local sy=stary[i]
		sy=sy+star_speed[i]
		if sy>128 then
			sy=sy-128
		end
		stary[i]=sy
	end
end

function text_anim()
	local color={5,5,5,5,5,5,5,5,6,7,7,7}
	if blink>#color then
		blink=1
	end
	return color[blink]
end
-->8
function draw_start()
	cls(1)
	print("zshmup",54,40,12)
	print("press 'z' or 'x' key to start",6,80,text_anim())
end

-- draw basic lelves
function draw_game()
		cls()
	--player ship
	spr(ship_spr, ship_pos_x, ship_pos_y)
	--ship engine fire
	spr(engine_f_spr, ship_pos_x, ship_pos_y+9)
	--bullet
	spr(bullet_spr, bullet_pos_x, bullet_pos_y)
	--muzzle flash
	if muzzle>0 then
		circfill(ship_pos_x+3,ship_pos_y,muzzle,7)
	end
	--score
	draw_score()
	--lives
	draw_lives()
	--starfield
	draw_starfield()
end

function draw_game_over()
	cls(8)
	print("game over",54,40,12)
	print("press 'z' or 'x' key to start",6,80,text_anim())
end
-->8
--start screen
function update_start()
	if btnp(4) or btnp(5) then
		state="game"
		reset()
	end
end
--game
function update_game()
	stage_limit()
	bullet_move()
	p_controls()
	engine_anim()
	bullet_anim()
	muzzle_anim()
	starfield_anim()
end

function update_game_over()
	if btnp(4) or btnp(5) then
		state="start"
	end
end
-->8
-- helpers

function stage_limit() 
	if ship_pos_x < 0 then
		ship_pos_x = 0
	end
	if ship_pos_x > 120 then
		ship_pos_x = 120
	end
	if ship_pos_y > 120 then
		ship_pos_y = 120
	end
	if ship_pos_y < 0 then
		ship_pos_y = 0
	end
end

function reset()
		--player vars
	lives=2
	ship_spr=2
	ship_pos_x=64
	ship_pos_y=64
	--engine fire
	engine_f_spr=4
	--bullet
	bullet_spr=9
	bullet_pos_x=ship_pos_x
	bullet_pos_y=-10
	--muzzle
	muzzle=0
	--score
	score=3000
	--stars
	starx={}
	stary={}
	star_speed={}
	for i=1,100 do
		add(starx,flr(rnd(128)))
		add(stary,flr(rnd(128)))
		add(star_speed,rnd(1.5)+0.5)
	end
end


__gfx__
00000000000800000008800000008000009999000009900000099000000990000099990000000000000000000000000000000000000000000000000000000000
00000000000180000081180000081000000aa000000aa00000099000000aa000000aa00000899800000000000089980000077000000000000000000000000000
0070070000868000008168000008180000000000000aa000000aa000000aa00000000000089aa98000899800089aa98007777770000770000000000000000000
000770000081880008821880008818000000000000000000000aa000000000000000000008977980089779800897798077777777007777000007700000000000
00077000088292808291292808292880000000000000000000000000000000000000000008977980089779800897798007777770000770000000000000000000
007007000881928082921928082918800000000000000000000000000000000000000000089aa98000899800089aa98000077000000000000000000000000000
00000000008292000291292000292800000000000000000000000000000000000000000000899800000000000089980000000000000000000000000000000000
00000000009090000090090000090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000000880000008800008800880088008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007e0000007e0000000e00088888888800880080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
088ee880088ee880088e088088888888800000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88822888888228888882208888888888800000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02288220022882200228820088888888800000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000000880000008800008888880080000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000000880000008800000888800008008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222200002222000022220000088000000880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00800000000880000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00180000008118000000810000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08680000008168000000818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08188000088218800008818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88292800829129280082928800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88192800829219280082918800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08292000029129200002928000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09890000009009000000989000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00010000321502e1202915025150211101f1501b150191501515012150101500e1500d1500c1500b1500a15000100001000010000100001000010000100001000010001100001000010000100011000110000100
